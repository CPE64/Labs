%| Weekly report template for CSUS Senior Design
%|
%| language: LaTeX
%| Author: Ben Smith
%| 
%| This source has been tagged with the "<CHANGE" tag in areas
%| that require updating when making a new docuent
%|
%| This source will generate a PDF file complete with thumbnails navigation menu and metadata.
%| Much of the tex awesomeness comes from http://www.michaelshell.org/ praise be to him for creating the guide

\documentclass[12pt,journal]{IEEEtran}

\newcommand{\TITLE}{Lab Two: Introduction to Verilog}
\newcommand{\KEYWORDS}{Logic Gates, Verilog, FPGA, Signaltap, Synthesis}
\newcommand{\ABSTRACT}{Two input logic gates are synthesized for the Altera Cyclone IV FPGA using the Quartus IDE. The logic
                       gates are verified using a System Verilog testbench and Mentor's Modelsim HDL simulator}

%| Override compsoc class' Palatino font for body text, restores to Times New Roman
\renewcommand{\rmdefault}{ptm}\selectfont

%| IEEE Citation package
\usepackage{cite}

\usepackage[cmex10]{amsmath}        %| Asmerican Mathematical Society package for fancy maths  
\interdisplaylinepenalty=2500       %| Restores IEEE line spacing after amsmath

%| Better tables than LaTeX 2e
\usepackage{array}
\usepackage{color}
\usepackage{graphicx}
\usepackage{float}
\usepackage{url}                    %| Improved URL handling
%\usepackage{minted}
\usepackage{etoolbox}
%\AtBeginEnvironment{minted}{\singlespacing
%    \fontsize{9}{p}\selectfont}

\usepackage{listings}
\definecolor{mygreen}{rgb}{0,0.6,0}
\definecolor{mygray}{rgb}{0.5,0.5,0.5}
\definecolor{mymauve}{rgb}{0.58,0,0.82}
\lstset{ %
  backgroundcolor=\color{mygray},     % choose the background color; you must add \usepackage{color} or \usepackage{xcolor}
  basicstyle=\footnotesize\ttfamily,  % the size of the fonts that are used for the code
  breakatwhitespace=false,            % sets if automatic breaks should only happen at whitespace
  breaklines=true,                    % sets automatic line breaking
  captionpos=b,                       % sets the caption-position to bottom
  commentstyle=\color{mygreen},       % comment style
  deletekeywords={...},               % if you want to delete keywords from the given language
  escapeinside={\%*}{*)},             % if you want to add LaTeX within your code
  extendedchars=true,                 % lets you use non-ASCII characters; for 8-bits encodings only, does not work with UTF-8
  frame=single,                       % adds a frame around the code
  keepspaces=true,                    % keeps spaces in text, useful for keeping indentation of code (possibly needs columns=flexible)
  keywordstyle=\color{blue},          % keyword style
  language=Verilog,                   % the language of the code
  morekeywords={*,...},               % if you want to add more keywords to the set
  numbers=left,                       % where to put the line-numbers; possible values are (none, left, right)
  numbersep=5pt,                      % how far the line-numbers are from the code
  numberstyle=\tiny\color{mygray},    % the style that is used for the line-numbers
  rulecolor=\color{black},            % if not set, the frame-color may be changed on line-breaks within not-black text (e.g. comments (green here))
  showspaces=false,                   % show spaces everywhere adding particular underscores; it overrides 'showstringspaces'
  showstringspaces=false,             % underline spaces within strings only
  showtabs=false,                     % show tabs within strings adding particular underscores
  stepnumber=1,                       % the step between two line-numbers. If it's 1, each line will be numbered
  stringstyle=\color{mymauve},        % string literal style
  tabsize=2,                          % sets default tabsize to 2 spaces
  title=\lstname                      % show the filename of files included with \lstinputlisting; also try caption instead of title
}

%| Enables PDF metadata, thumbnails, and navigation
\newcommand\MYhyperrefoptions{
  bookmarks=true,
  bookmarksnumbered=true,
  pdfpagemode={UseOutlines},
  plainpages=false,
  pdfpagelabels=true,
  colorlinks=true,
  linkcolor={black},
  citecolor={black},
  urlcolor={blue},
  pdftitle={CPE/EEE 64: Lab One},
  pdfsubject={Engineering},                        
  pdfauthor={California State University Sacramento},
  pdfkeywords={\KEYWORDS}}                       

%| Calls hyperref package with the options specified above
\usepackage[\MYhyperrefoptions,pdftex]{hyperref}

\begin{document}
%| Inserts header cover sheet 
\include{Title_Page}
\include{TOC}


  %| =================================================================================================
  %| Introduction
  %| =================================================================================================
  \section{Introduction}
    \PARstart{T}{his} lab introduces the DE0-Nano and Altera's Quartus development environment. Quartus will be
    used to program the Altera FPGA on the DE0-Nano. We will start by using Quartus' schematic representation of logic modules. 
    This will be very similar to the logic that you have created in Multisim. The schematic editor in Quartus can be
    used to graphically represent Verilog modules, like you will do in Lab Two, or logic primitives like will be done
    in this lab. This lab is created to introduce the student to the following concepts.
    \begin{itemize}
       \item Logic primitives on the FPGA
       \item Quartus development environment
       \item Synthesis of a block based design
       \item Assigning pins for a design
       \item Programming an Altera FPGA
    \end{itemize}

    \subsection{Included Screencasts}
      A number of screencasts are included with this set of labs. They are available on Youtube and as zipped MP4s
      on the course website. They are intended to be short and to the point so they cover individual topics.
      \begin{enumerate}
        \item Installing Quartus
        \item Opening, Compiling, programming with Quartus
        \item Block editor in Quartus
        \item Pin assignments in quartus.
      \end{enumerate}
    % \PARstart{V}{erilog} is a powerful way to describe circuits. Logic diagrams like those being used in lecture 
    % can become cumbersome in large designs. ``Text based design entry'' can be less prone to error because 
    % it is easier to track differences in large designs. Verilog is a text based hardware descriptive language
    % the begun being used in ASIC(Application Specific Integrated Circuit) and now is the language of choice for
    % FPGAs(Field Programmable Gate Array). We will be using the Terasic DE0-Nano development board with an Altera 
    % Cyclone IV FPGA on board. Altera provides a comprehensive solution for programming and debugging their FPGAs 
    % called Quartus. These labs will explore Quartus and use it to program the FPGA on the DE0-Nano development 
    % board. In this lab we will:
    % \begin{itemize}
    %   \item Instantiate a System Verilog module
    %   \item Use a System Verilog Testbench
    %   \item Interact with external switches and indicators
    %   \item Synthesize Verilog code for a FPGA
    % \end{itemize}
  
    % \subsection{\bfseries Verilog Modularity}
    %   One of the most important features of Verilog is it's ability to reuse a design. Reusing code allows you to
    %   rapidly assemble and test new designs. The ability to rapidly prototype a design is one the biggest advantages 
    %   to the FPGA. This section will involve provided logic gate Verilog modules which will be reused in later labs to 
    %   build more complex structures. Reusing these modules is very similar to how you would reuse code in the workplace 
    %   to be more productive. The lab documentation comes with Verilog implementations of the four logic gates in 
    %   {\bfseries Source.zip} The demo for the lab will be implementing these modules with the DE0-Nano development
    %   board and testing the design on a breadboard. You could think of this as the source libraries that would
    %   be available at the company that you might work for. 

    % \subsection{\bfseries Test Bench}
    %   Verilog roughly breaks into two halves synthesizable and non-synthesizable. FPGAs synthesis can
    %   take a very long time, using a simulator to verify individual modules can be much faster than
    %   resynthesizing the entire design. The Testbench also offers a unique ability to check expected
    %   outputs generate test stimulus. We will use a test bench to check the provided Verilog modules
    %   are providing the desired operation in part C of the procedure. This simulation should be verified
    %   against the known truth table for the logic gate to ensure the module is accurate.

  %| =================================================================================================
  %| Procedure
  %| =================================================================================================
  \section{Lab Procedure}
    \PARstart{T}{his} section is a guide for what must be accomplished in the lab. Keep in mind the some of
    the following material will need to be documented in your lab report. For this section you will need:
    \begin{itemize}
      \item DE0-Nano Development board
      \item A breadboard
      \item Four LEDs
      \item Two dip switches
      \item Windows or Linux based computer
      \item Internets
    \end{itemize}

    %| Step Zero: Install Quartus
    %| =================================================================================================
    \subsection{Install Quartus}
    Download most recent version of Quartus and Cyclone device drivers from Altera. Screencast 1
    is a walk through for windows, but Quartus is also available for Linux.

    %| Step One: Expand source .zip
    %| =================================================================================================
    \subsection{Expand Source.Zip}
    The Quartus project file, logic gate modules, and test bench are contained within this archive. 
    Expand it wherever is convenient for you, it will be accessed frequently. The Quartus project file
    included with the source code is generated with the Terasic DE0-Nano System Builder that is included
    with the Terasic System CD. You can use this if you want to generate a clean project for yourself.
    \begin{figure}[H]
      \includegraphics[width=.48\textwidth]{Images/screenshot_88.jpg}
      \caption{TerasIC System Builder GUI}
    \end{figure}
    
%     %| Step Two: Compile and run testbench
%     %| =================================================================================================
%     \subsection{\bfseries Run testbench}
%     Now we want to verify our design. Using a simulator for a single logic gate is a bit asinine but
%     the experience gained with the example test bench will help you greatly in the future. Start a new simulation 
%     and add the waveforms as shown in screencast 2. You'll want to have have truth tables laid out for the
%     gates your testing so you can be sure they behave the way you expect. Have an extra column ready to record
%     the behavior of the FPGA once it's programed. Figure \ref{LogicOut} shows an example of what the wave section
%     should look like.
%     \begin{figure}[H]
%       \label{LogicOut}
%       \includegraphics[width=.48\textwidth]{Images/LogicOutput.png}
%       \caption{Example output of testbench}
%     \end{figure}
%     Take a moment to look at the simulation transcript, it provides the states of the logic elements being tested.
%     I prefer having the simulator give a test listing instead of reading the waveforms. This is from the \$display()
%     lines in the testbench. listing the outputs can be a very powerful debugging tool. I typically use the \$assert()
%     statement which can pause the simulation and alert you when an unexpected result is produced.
%     \begin{lstlisting}
% A:0 B:0 - Inverter:1 AND:0 OR:0 NAND:1
% A:0 B:1 - Inverter:1 AND:0 OR:1 NAND:1
% A:1 B:0 - Inverter:0 AND:0 OR:1 NAND:1
% A:1 B:1 - Inverter:0 AND:1 OR:1 NAND:0
%     \end{lstlisting}

    %| Step Two: Open Quartus project
    %| =================================================================================================
    \subsection{Open Quartus project}
    Navigate to where you expanded the Source.zip file. The Quartus project file you want to open is called
    ``./Verilog/Quartus Project/64LabOne.qpf'' When you open the project file open the ``Top Level'' .BDF file
    Inside this file there will be a number of logic gates attached to pins of the FPGA. A screen cast explains the
    intricacies of the Schematic editor. 
      \begin{figure}[H]
        \includegraphics[width=.48\textwidth]{Images/LogicPreview.png}
        \caption{Quartus logic schematic editor example}
      \end{figure}

    %| Step Three: Prepare circuit
    %| =================================================================================================
    \subsection{Prepare circuit to test Verilog gate modules with DE0-Nano}
      A switch and LED are going to be used to test the FPGA while it's operating. This switch will allow you to generate inputs for the FPGA. The LED circuit needs a current limiting resistor as shown in the Figure below.
      \begin{figure}[H]
        \label{LEDCircuit}
        \includegraphics[width=.48\textwidth]{Schematics/LED.pdf}
        \caption{LED with current limiting resistor}
      \end{figure}
      The LED will allow you to see the the output but we'll also need to be able to generate some input for
      the FPGA. We will do this with a dip switch and pulldown resistor. The pulldown resistor is needed
      to literally pull the charge off the wire so the input will read a solid zero. Otherwise the pin would ``float''
      between 1 and 0 arbitrarily.
      \begin{figure}[H]
        \label{swPulldown}
        \includegraphics[width=.48\textwidth]{Schematics/SwitchCircuit.pdf}
        \caption{Switch with pulldown resistor}
      \end{figure}

      %| GPIO Headers
      \subsubsection{GPIO headers on the DE0-Nano}
        Be careful when referencing the pin diagrams in the DE0-Nano user manual. It is easy to read it backwards and
        that can be a mistake that will cost you hours. It is easiest to match the Nano's orientation with the schematic
        and count from the nearest edge. Always check VCC\_SYS, VCC3P3, and GND with a multimeter before attaching a circuit
        you have built. 
        \begin{figure}[H]
          \includegraphics[width=.48\textwidth]{Images/GPIOHeader.jpg}
          \caption{Schematic of GPIO-0 header\cite{DE0Manual}}
        \end{figure}
        This is the header pin schematic from the DE0-Nano user manual. Inside the verilog code these pins follow a little
        different nomenclature. What is labeled as GPIO\_0\_IN[0] in figure 5 is GPIO0\_IN[0] and GPIO\_00 is GPIO0[0]. Refer
        to the DE0-Nano user guide for details on the orientation of the headers.

        \begin{figure}[H]
          \includegraphics[width=.45\textwidth]{Images/GPIOpicture.jpg}
          \caption{Picture of loaded GPIO-0 header}
        \end{figure}

        \begin{figure}[H]
          \includegraphics[width=.48\textwidth]{Images/ExampleLayout.jpg}
          \caption{Example switch and LED configuration with SIP resistors}
        \end{figure}

      %| Step Five: Compile
      \subsubsection{Compile example with Quartus}
        Once you've created and tested your switch circuit we'll need to compile the example project. This can be done
        with the Quartus development environment. A walk through is provided in screencastX. 

      %| Step Six: Program Nano
      \subsubsection{Use Quartus to program the Nano} refer to screencastX for a walk through. After synthesis
      Quartus will generate a .SOF\footnote{the .SOF stands for SRAM object file. This is an Altera standard for
      of their FPGAs.} file that can be used to program the FPGA using Quartus' programmer. Follow the procedure
      outlined in screencastX.
        
      %| Step Seven: Record Results
      %| =================================================================================================
      \subsection{Test behavior against expected truth table} 
      Use the known behavior of the logic gates to test your design on the FPGA. 

      %| Step Eight: Create XOR from logic primitives
      %| =================================================================================================
      \subsection{Design XOR module} 
        Now that you have had the opportunity to experiment with the logic primitives in the schematic editor the time has come to create your own design. Lets say that we need a four input XOR gate for some reason. We know the truth table of a XOR gate, it must be high when any number of the inputs is high but all of them as shown in Table \ref{XORTT}. Quartus does have an embedded XOR primitive which the use of is disallowed. Create the circuit from the basic 7400series logic operators. Always remember, Google is your best friend. 
        \begin{table}[H]
          \renewcommand{\arraystretch}{1.3}
            \caption{Truth table for XOR logic function}
            \label{XORTT}
            \centering
            \begin{tabular}{c|c|c|c|c}
            \hline
              A &B &C &D &Output Q \\
            \hline\hline
              0 &0 &0 &0 &0\\
              0 &0 &0 &1 &1\\
              0 &0 &1 &0 &1\\
              0 &0 &1 &1 &1\\
              0 &1 &0 &0 &1\\
              0 &1 &0 &1 &1\\
              0 &1 &1 &0 &1\\
              0 &1 &1 &1 &1\\
              1 &0 &0 &0 &1\\
              1 &0 &0 &1 &1\\
              1 &0 &1 &0 &1\\
              1 &0 &1 &1 &1\\
              1 &1 &0 &0 &1\\
              1 &1 &0 &1 &1\\
              1 &1 &1 &0 &1\\
              1 &1 &1 &1 &0\\
            \hline
            \end{tabular}
          \end{table}

      %| Step Eight: Create XOR from logic primitives
      %| =================================================================================================
      \subsection{Design AOI module from logical equation} 
      The ``And or Invert'' function is common in digital design, you will implement it with logic primitives.

      \begin{displaymath}
        F = \overline{(A \wedge B) \vee (C \wedge D)}
      \end{displaymath}

      % Now that you've had the opportunity to experiment with the provided modules the time had come to write
      % your own module. When starting a module it's usually best to copy something you know works and modify it
      % to suit your need. In this case I would make a copy of AND.sv and change the logic to XOR. Verilog does
      % have a built in operator for this. Your best friend is google, that's always the best place to start.

  %| =================================================================================================
  %| Lab Report Requirements
  %| =================================================================================================
  \section{Lab Report}
    \IEEEPARstart{T}{he} lab report must be typed and submitted in a PDF format. Look to IEEE's guidelines for  guidelines on format. The document should include the following items.
    
    \subsection{Figures to include}
    \begin{itemize}
      \item Schematic of your XOR Gate
      \item Logic tables from theoretical prediction and experimental outcome
      \item Explanation and schematic of your XOR module.
      \item Explanation and Schematic of your AOI module.
    \end{itemize}

    \subsection{Questions to answer}
    \begin{enumerate}
      \item Notice the report that pops up when you compile your project. There are a number of statistics given
            by Quartus, the logic element usage ratio is your designs use of the total device capacity.
      \item The synthesis engine in Quartus is very powerful and will optimize your design for the resources on the FPGA. Quartus generates the design using three logic gates and two inverters, which gates do you think it changed to inverters?
    \end{enumerate}

  %| =================================================================================================
  %| Conclusions
  %| =================================================================================================
  \section{Conclusion}
    \IEEEPARstart{T}{this} lab introduced Quartus and some of it's basic functionality. Quartus is very similar to many industry standard tools. Xilinx, another manufacturer of programmable logic, offers a tool suite very similar to Quartus called ISE. An understanding of Quartus will allow ISE to be learned very quickly.

     The block editor introduced in theis section can also generate block diagrams for Verilog modules, which will be explored in Lab 3. While Verilog is a much more efficient way to create a digital design, the high level block diagram can serve as a great visualization tool when combined with the behavioral modeling of Verilog.

    % \IEEEPARstart{V}{erilog} is an IEEE standard(1364)\cite{Wikipedia:Verilog}, it is pervasive in industry and can be used to develop specialized hardware
    % in the form of ASICs or reconfigurable FPGAs. It is important to underscore the differences between Verilog
    % and a programming language like C, Java, even Assembly. Verilog offers the ability to take parallel action.
    % Two numbers can be multiplied at once, multiple registers can be set and cleared. Entire microprocessors can
    % be implemented on the Nano, one of the later labs will explore Altera's softprocessor the NIOS II. The TerASIC
    % documentation included with the DE0-Nano kit is pretty good and worth the read. It will help you get the most
    % out of the FPGA. The CD included with the Nano will also include circuit schematics that can provide a great
    % reference when it comes time to make one of your own.
    
    \paragraph{More Information} just like anything else, the Internet has an amazing amount of information available
    for the interested student. 
      \begin{itemize}
        \item \href{http://www.altera.com/education/training/curriculum/fpga/trn-fpga.html}{Altera Traning Curriculum for FPGA designers}
        \item \href{www.eevblog.com}{EEV Blog: What is a FPGA?}
      \end{itemize}

  %| =================================================================================================
  %| Bibliography
  %| =================================================================================================
  \bibliographystyle{IEEEtran}
  \bibliography{IEEEfull}
\end{document}